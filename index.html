<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Регистрация</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="./styles.css">
  <!-- Важно: стили формы в исходнике могли быть на стороне Tilda/общего CSS.
       Если на Pages "голый" вид — нужно добавить CSS отдельно. -->
</head>

<body>

<!-- ====== ТВОЯ ФОРМА (КАК В ФАЙЛЕ) ====== -->
<!-- FT FORM CORE v2.4 - НЕ МЕНЯТЬ СТИЛИ В ЭТОМ ФАЙЛЕ -->
<div id="ft-form-universal" class="ft-form-core" style="opacity: 0; transition: opacity 0.5s ease;" data-popup="popupRegistration">

  <!-- Форма регистрации -->
  <form id="ftForm" class="ft-form" autocomplete="on" novalidate>
    <!-- Имя -->
    <div class="ft-field">
      <label for="ftFirstname">Имя</label>
      <input id="ftFirstname" name="firstname" type="text" required />
    </div>

    <!-- Email -->
    <div class="ft-field">
      <label for="ftEmail">Твой актуальный email (пришлем на него билет)</label>
      <input id="ftEmail" name="email" type="email" required placeholder="name@example.com" />
      <div class="ft-error" id="ftErrEmail"></div>
    </div>

    <!-- Телефон -->
    <div class="ft-field">
      <label for="ftPhone">Номер телефона</label>
      <input id="ftPhone" name="mobteleph" type="tel" required placeholder="+79998887766" inputmode="tel" />
      <div class="ft-error" id="ftErrPhone"></div>
    </div>

    <!-- Форум -->
    <div class="ft-field" id="ftCareerdayWrap">
      <label for="ftCareerday">На какой форум ты планируешь прийти?</label>
      <select id="ftCareerday" name="careerday" required>
        <option value="" selected disabled>Выберите форум</option>
        <!-- Опции будут добавлены динамически -->
      </select>
    </div>

    <!-- ВУЗ -->
    <div class="ft-field ft-autocomplete">
      <label for="ftVuz">Текущее или последнее место учебы</label>
      <input id="ftVuz" name="vuz_title" type="text" placeholder="Начните вводить..." autocomplete="off" />
      <input type="hidden" id="ftVuzUnified" name="vuz_unified" value="" />
      <div class="ft-dropdown" id="ftVuzDropdown" style="display: none;"></div>
    </div>

    <!-- КУРС -->
    <div class="ft-field" id="ftYearWrap">
      <label for="ftYear">На каком курсе ты обучаешься?</label>
      <select id="ftYear" name="year_of_grad" required>
        <option value="" selected disabled>Выберите</option>
        <option>1 курс бакалавриата/специалитета</option>
        <option>2 курс бакалавриата/специалитета</option>
        <option>3 курс бакалавриата/специалитета</option>
        <option>4 курс бакалавриата/специалитета</option>
        <option>5 курс специалитета</option>
        <option>1 курс магистратуры</option>
        <option>2 курс магистратуры</option>
        <option>выпускник(-ца)</option>
        <option>другое</option>
      </select>
    </div>

    <!-- ВОЗРАСТ -->
    <div class="ft-field" id="ftAgeWrap" style="display:none;">
      <label for="ftAge">Возраст</label>
      <select id="ftAge" name="age">
        <option value="" selected disabled>Выберите</option>
        <option>16-17 лет</option>
        <option>18-20 лет</option>
        <option>21-23 года</option>
        <option>24-27 лет</option>
        <option>старше 27 лет</option>
      </select>
    </div>

    <!-- НАПРАВЛЕНИЕ -->
    <div class="ft-field" id="ftStreamWrap">
      <label for="ftStream" id="ftStreamLabel">На каком направлении обучаешься? Выбери самое близкое к факультету</label>
      <select id="ftStream" name="stream" required></select>
    </div>

    <!-- КАСТОМНЫЙ ФАКУЛЬТЕТ -->
    <div class="ft-field" id="ftCustomFacultyWrap" style="display:none;">
      <label for="ftCustomFaculty">Укажи, пожалуйста, свой факультет</label>
      <input id="ftCustomFaculty" name="custom_faculty" type="text" placeholder="Например: Факультет компьютерных наук" />
      <div class="ft-error" id="ftErrCustomFaculty"></div>
    </div>

    <!-- Чекбокс согласия -->
    <div class="ft-field">
      <label class="ft-consent-label">
        <input id="ftConsent" type="checkbox" required>
        <span class="ft-consent-text">
          Нажимая кнопку «Зарегистрироваться», Вы даёте согласие на
          <a href="https://fut.ru/adv_messages_agreement" target="_blank" rel="noopener">рассылку</a>,
          <a href="https://fut.ru/personal_data_agreement" target="_blank" rel="noopener">обработку персональных данных</a>,
          условия <a href="https://fut.ru/user-agreement" target="_blank" rel="noopener">Пользовательского соглашения</a>,
          <a href="https://fut.ru/personal-data" target="_blank" rel="noopener">Политики обработки персональных данных</a>
          и <a href="https://doc.fut.ru/media/2024/06/events_agreement.pdf" target="_blank" rel="noopener">Правила посещения Дня Карьеры</a>.
        </span>
      </label>
      <div class="ft-error" id="ftErrConsent"></div>
    </div>

    <!-- Скрытые поля -->
    <input type="hidden" id="ftLandingType" name="landing_type" value="">
    <input type="hidden" id="ftFormSource" name="form_source" value="tilda_html">
    <input type="hidden" id="ftStreamFinal" name="stream_final" value="">

    <!-- Кнопка отправки -->
    <div class="ft-button-container">
      <button id="ftSubmitBtn" class="ft-submit-btn" type="submit">Зарегистрироваться</button>
    </div>

    <!-- Сообщение формы -->
    <div class="ft-message" id="ftFormMsg"></div>
  </form>

  <!-- Сообщение об успехе -->
  <div class="ft-success-container" id="ftSuccessContainer" style="display:none;">
    <div class="ft-success-message">
      <div class="ft-success-title">
        <h2 class="ft-success-heading">ПОЛУЧИЛИ ТВОЮ РЕГИСТРАЦИЮ</h2>
      </div>

      <div class="ft-success-text" id="ftSuccessText"></div>

      <div class="ft-button-container">
        <button class="ft-close-btn" id="ftCloseSuccessBtn">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script>
// ====== FT FORM CORE v2.4 + Telegram адаптация ======
(function(){
  'use strict';

  // Telegram init (не ломает работу в обычном браузере)
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  // ================== КОНФИГУРАЦИЯ ==================
  const CONFIG = {
    API_BASE: "https://functions.yandexcloud.net/d4eajagq70ar2qug7ar5",
    IS_GENERAL_LANDING: true,
    LANDING_TYPE_GENERAL: "all_events",
    FORUM_FIXED: "ПФМ",
    SPREADSHEET_ID: "16a3MSd-b8F2T1EbwaFVBMyPmF5oat9UUajK3VytQuis",
    DOV_HIDE_STREAM: true,
    VUZ_MIN_CHARS: 2,
    VUZ_SUGGEST_LIMIT: 20
  };

  const SHEETS = {
    MSK_VUZ:  "МСК вузы",
    SPB_VUZ:  "СПБ вузы",
    MSK_SSUZ: "МСК ссузы",
    NSK_VUZ:  "НСК вузы",
  };

  const STREAMS = {
    PF: [
      "финансы / экономика",
      "консалтинг / аудит / бухгалтерский учет",
      "страхование",
      "налогообложение",
      "финансовая аналитика",
      "менеджмент / управление / HR",
      "юриспруденция",
      "маркетинг и медиа (реклама, SEO, SMM)",
      "инвестиции и предпринимательство",
      "международные отношения",
      "другое"
    ],
    NIT: [
      "программирование / разработка ПО",
      "веб-разработка",
      "мобильная разработка",
      "Data Science / ML / AI",
      "кибербезопасность",
      "DevOps / системное администрирование",
      "тестирование (QA)",
      "анализ данных",
      "дизайн (UI/UX)",
      "продукт-менеджмент",
      "другое"
    ],
    TCM: [
      "инженерное дело",
      "машиностроение",
      "строительство",
      "электротехника",
      "робототехника",
      "биотехнологии",
      "нанотехнологии",
      "автоматизация",
      "проектирование",
      "технический контроль",
      "другое"
    ],
    DOV: [
      "менеджмент",
      "административная работа",
      "продажи",
      "клиентский сервис",
      "маркетинг",
      "реклама",
      "дизайн",
      "IT",
      "финансы",
      "юриспруденция",
      "другое"
    ]
  };

  const FORUM_NAMES_WITH_DATES = {
    'ПФМ': 'ProFinance в Москве 11 марта',
    'НИТМ': 'Найти IT в Москве 12 марта',
    'ТСМ': 'TechnoCareer в Москве 21 марта',
    'ПФС': 'ProFinance в Санкт-Петербурге 3 апреля',
    'НИТС': 'Найти IT в Санкт-Петербурге 4 апреля',
    'НИТН': 'Найти IT в Новосибирске 14 апреля',
    'ДОВ': 'День открытых вакансий в Москве 27 апреля'
  };

  const TG_CHANNELS = {
    'ПФМ': { text: '@ft_profinance', url: 'https://t.me/ft_profinance' },
    'НИТМ': { text: '@findit_msk', url: 'https://t.me/findit_msk' },
    'ТСМ': { text: '@technocareer', url: 'https://t.me/technocareer' },
    'ПФС': { text: '@profinance_spb', url: 'https://t.me/profinance_spb' },
    'НИТС': { text: '@findit_spb', url: 'https://t.me/findit_spb' },
    'НИТН': { text: '@findit_nsk', url: 'https://t.me/findit_nsk' },
    'ДОВ': { text: '@fut_vacancyday', url: 'https://t.me/fut_vacancyday' }
  };

  // ====== DOM ======
  const formCore = document.getElementById('ft-form-universal');
  const form = document.getElementById('ftForm');
  const successContainer = document.getElementById('ftSuccessContainer');
  const closeSuccessBtn = document.getElementById('ftCloseSuccessBtn');
  const successText = document.getElementById('ftSuccessText');

  const firstnameInp = document.getElementById('ftFirstname');
  const emailInp = document.getElementById('ftEmail');
  const phoneInp = document.getElementById('ftPhone');
  const careerdayWrap = document.getElementById('ftCareerdayWrap');
  const careerdaySel = document.getElementById('ftCareerday');
  const vuzInp = document.getElementById('ftVuz');
  const vuzUnifiedInp = document.getElementById('ftVuzUnified');
  const vuzDropdown = document.getElementById('ftVuzDropdown');
  const yearWrap = document.getElementById('ftYearWrap');
  const ageWrap = document.getElementById('ftAgeWrap');
  const yearSel = document.getElementById('ftYear');
  const ageSel = document.getElementById('ftAge');
  const streamWrap = document.getElementById('ftStreamWrap');
  const streamLabel = document.getElementById('ftStreamLabel');
  const streamSel = document.getElementById('ftStream');
  const customFacultyWrap = document.getElementById('ftCustomFacultyWrap');
  const customFacultyInp = document.getElementById('ftCustomFaculty');
  const errCustomFaculty = document.getElementById('ftErrCustomFaculty');
  const streamFinalInp = document.getElementById('ftStreamFinal');
  const consentChk = document.getElementById('ftConsent');
  const submitBtn = document.getElementById('ftSubmitBtn');
  const formMsg = document.getElementById('ftFormMsg');
  const landingTypeInp = document.getElementById('ftLandingType');

  const errEmail = document.getElementById('ftErrEmail');
  const errPhone = document.getElementById('ftErrPhone');
  const errConsent = document.getElementById('ftErrConsent');

  // На GitHub Pages не должно быть "белого экрана"
  setTimeout(() => { if (formCore) formCore.style.opacity = '1'; }, 50);

  // Telegram: автоподстановка имени (если пусто)
  if (tg?.initDataUnsafe?.user && firstnameInp && !firstnameInp.value) {
    firstnameInp.value = tg.initDataUnsafe.user.first_name || '';
  }

  // ====== UTILS ======
  function setError(el, text) {
    if (!el) return;
    el.style.display = text ? 'block' : 'none';
    el.textContent = text || '';
  }

  function normalizePhone(raw) {
    let s = (raw || '').trim().replace(/[^\d+]/g, '');
    if (/^8\d{10}$/.test(s)) s = '+7' + s.slice(1);
    if (/^7\d{10}$/.test(s)) s = '+7' + s;
    return s;
  }

  function isValidPhone(s) { return /^\+7\d{10}$/.test(s); }
  function isValidEmail(s) { return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test((s || '').trim()); }

  function toggleCustomFacultyField(show) {
    if (!customFacultyWrap) return;
    customFacultyWrap.style.display = show ? 'block' : 'none';
    if (!show) {
      customFacultyInp.value = '';
      setError(errCustomFaculty, '');
    }
  }

  function updateStreamFinalValue() {
    const streamValue = streamSel.value;
    if (streamValue === 'другое') {
      const customValue = (customFacultyInp.value || '').trim();
      streamFinalInp.value = customValue ? customValue : 'другое';
    } else {
      streamFinalInp.value = streamValue;
    }
  }

  function getForumNameWithoutDate(code) {
    const fullName = FORUM_NAMES_WITH_DATES[code] || code;
    return fullName.replace(/\s\d+\s[а-я]+$/, '');
  }

  function getTgChannel(code) {
    return TG_CHANNELS[code] || TG_CHANNELS['НИТМ'];
  }

  function generateSuccessText(forumCode) {
    const forumName = getForumNameWithoutDate(forumCode);
    const tgChannel = getTgChannel(forumCode);

    return `Получили твою регистрацию на ${forumName}.<br>
            Отправим письмо с билетом на указанную тобой почту.<br>
            Если не увидишь его, проверь спам и промоакции — иногда письмо улетает туда (особенно актуально для Gmail-почт).<br><br>

            А еще подписывайся на наш ТГ <a href="${tgChannel.url}" class="ft-tg-link" target="_blank" rel="noopener">${tgChannel.text}</a> — там все актуальности.<br>
            Связь с организаторов: <a href="mailto:careerday@futuretoday.ru" class="ft-email-link">careerday@futuretoday.ru</a> или <a href="https://t.me/careerday_help" class="ft-help-link" target="_blank" rel="noopener">@careerday_help</a>`;
  }

  // ====== SUCCESS / CLOSE ======
  function showSuccessMessage() {
    const forumCode = CONFIG.IS_GENERAL_LANDING ? careerdaySel.value : CONFIG.FORUM_FIXED;
    successText.innerHTML = generateSuccessText(forumCode);

    form.style.display = 'none';
    successContainer.style.display = 'block';

    setTimeout(() => {
      formCore.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
  }

  function closeSuccess(e) {
    e?.preventDefault?.();

    // В Telegram закрываем WebApp
    if (tg) {
      tg.close();
      return;
    }

    // В браузере просто сбросим форму
    successContainer.style.display = 'none';
    form.style.display = 'block';
    form.reset();

    vuzUnifiedInp.value = '';
    if (vuzDropdown) { vuzDropdown.style.display = 'none'; vuzDropdown.innerHTML = ''; }
    toggleCustomFacultyField(false);
    streamFinalInp.value = '';
  }

  if (closeSuccessBtn) closeSuccessBtn.addEventListener('click', closeSuccess);

  // ====== LANDING TYPE ======
  const landingTypeByPath = [
    { contains: "/profinance_msk_new", value: "pfm_new" },
    { contains: "/profinance_msk_test", value: "pfm_test" },
    { contains: "/profinance_msk", value: "pfm_old" },
    { contains: "/page114528496", value: "pfm_dev" },
    { contains: "/profinance_spb_new", value: "pfs_new" },
    { contains: "/profinance_spb", value: "pfs_old" },
    { contains: "/findit_msk_new", value: "nitm_new" },
    { contains: "/findit_msk_test", value: "nitm_test" },
    { contains: "/findit_msk", value: "nitm_old" },
    { contains: "/findit_spb_new", value: "nits_new" },
    { contains: "/findit_spb_test", value: "nits_test" },
    { contains: "/findit_spb", value: "nits_old" },
    { contains: "/findit_nsk_new", value: "nitn_new" },
    { contains: "/findit_nsk_test", value: "nitn_test" },
    { contains: "/findit_nsk", value: "nitn_old" },
    { contains: "/technocareer_msk_new", value: "tcm_new" },
    { contains: "/technocareer_msk_test", value: "tcm_test" },
    { contains: "/technocareer_msk", value: "tcm_old" },
    { contains: "/vacancyday_new", value: "dov_new" },
    { contains: "/vacancyday_test", value: "dov_test" },
    { contains: "/vacancyday", value: "dov_old" },
  ];

  function detectLandingType() {
    const path = (location.pathname || "").toLowerCase();
    const hit = landingTypeByPath.find(x => path.includes(x.contains));
    return hit ? hit.value : "";
  }

  // ====== FORUM UI ======
  function forumToKey(cd) {
    if (cd === "ПФМ" || cd === "ПФС") return "PF";
    if (cd === "НИТМ" || cd === "НИТС" || cd === "НИТН") return "NIT";
    if (cd === "ТСМ") return "TCM";
    if (cd === "ДОВ") return "DOV";
    return "PF";
  }

  function applyForumUI(cd) {
    const key = forumToKey(cd);

    if (cd === "ДОВ") {
      yearWrap.style.display = "none";
      yearSel.required = false;

      ageWrap.style.display = "block";

      if (CONFIG.DOV_HIDE_STREAM) {
        streamWrap.style.display = "none";
        streamSel.required = false;
        toggleCustomFacultyField(false);
      } else {
        streamWrap.style.display = "block";
        streamLabel.textContent = "Какие вакансии тебе интересны?";
        streamSel.required = true;
      }
    } else {
      yearWrap.style.display = "block";
      yearSel.required = true;

      ageWrap.style.display = "none";

      streamWrap.style.display = "block";
      streamLabel.textContent = "На каком направлении обучаешься? Выбери самое близкое к факультету";
      streamSel.required = true;
    }

    if (streamWrap.style.display !== "none") {
      const opts = STREAMS[key] || [];
      streamSel.innerHTML = "";
      const p = document.createElement("option");
      p.value = "";
      p.disabled = true;
      p.selected = true;
      p.textContent = "Выберите";
      streamSel.appendChild(p);

      opts.forEach(v => {
        const o = document.createElement("option");
        o.textContent = v;
        streamSel.appendChild(o);
      });

      // Важно: не плодим обработчики при каждом applyForumUI
      streamSel.onchange = function() {
        if (this.value === 'другое') toggleCustomFacultyField(true);
        else toggleCustomFacultyField(false);
        updateStreamFinalValue();
      };

      if (customFacultyInp) {
        customFacultyInp.oninput = function() { updateStreamFinalValue(); };
      }
    }

    toggleCustomFacultyField(false);
  }

  function populateForumOptions() {
    if (!careerdaySel) return;

    while (careerdaySel.options.length > 1) {
      careerdaySel.remove(1);
    }

    Object.entries(FORUM_NAMES_WITH_DATES).forEach(([code, nameWithDate]) => {
      const option = document.createElement("option");
      option.value = code;
      option.textContent = nameWithDate;
      careerdaySel.appendChild(option);
    });

    careerdaySel.onchange = function() {
      applyForumUI(this.value);
      loadedSheet = "";
      ensureVuzLoaded().catch(() => {});
    };
  }

  // ====== VUZ AUTOCOMPLETE ======
  function normalizeText(s) {
    // Если в Telegram WebView будут проблемы с \p{L}, замени на более простую регулярку.
    return (s || "")
      .toLowerCase()
      .replace(/ё/g, "е")
      .replace(/[^\p{L}\p{N}\s\-\(\)\.]/gu, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function csvUrlBySheetName(sheetName) {
    const sheet = encodeURIComponent(sheetName);
    return `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${sheet}`;
  }

  function detectCityFromForum(cd) {
    if (cd === "ПФС" || cd === "НИТС") return "SPB";
    if (cd === "НИТН") return "NSK";
    if (cd === "ДОВ" || cd === "ПФМ" || cd === "НИТМ" || cd === "ТСМ") return "MSK";
    return "";
  }

  function detectCityFallbackFromLandingType(lt) {
    const l = (lt || "").toLowerCase();
    const p = (location.pathname || "").toLowerCase();
    if (l.startsWith("nitn_") || l.includes("nsk") || p.includes("findit_nsk")) return "NSK";
    if (l.startsWith("pfs_") || l.startsWith("nits_") || l.includes("spb") || p.includes("profinance_spb") || p.includes("findit_spb")) return "SPB";
    return "MSK";
  }

  function pickSheetName() {
    const cd = CONFIG.IS_GENERAL_LANDING ? (careerdaySel.value || "") : CONFIG.FORUM_FIXED;
    if (cd === "ДОВ") return SHEETS.MSK_SSUZ;

    const cityByForum = detectCityFromForum(cd);
    const city = cityByForum || detectCityFallbackFromLandingType(landingTypeInp.value || detectLandingType());

    if (city === "NSK") return SHEETS.NSK_VUZ;
    if (city === "SPB") return SHEETS.SPB_VUZ;
    return SHEETS.MSK_VUZ;
  }

  function parseCSV(text) {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];

      if (inQuotes) {
        if (ch === '"') {
          if (text[i + 1] === '"') { cur += '"'; i++; }
          else inQuotes = false;
        } else cur += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ",") { row.push(cur); cur = ""; }
        else if (ch === "\n") { row.push(cur); rows.push(row); row = []; cur = ""; }
        else if (ch !== "\r") cur += ch;
      }
    }
    if (cur.length || row.length) { row.push(cur); rows.push(row); }
    return rows;
  }

  function findColIndex(headers, variants) {
    const normHeaders = headers.map(h => normalizeText(h));
    for (const v of variants) {
      const nv = normalizeText(v);
      const idx = normHeaders.findIndex(h => h === nv);
      if (idx !== -1) return idx;
    }
    return -1;
  }

  let vuzEntries = [];
  let loadedSheet = "";
  const sheetCache = new Map();

  async function loadVuzSheet(sheetName) {
    if (sheetCache.has(sheetName)) return sheetCache.get(sheetName);

    const url = csvUrlBySheetName(sheetName);
    try {
      const r = await fetch(url, { method: "GET", mode: "cors" });
      if (!r.ok) throw new Error("Не удалось загрузить CSV из Google Sheets");
      const text = await r.text();

      const rows = parseCSV(text).filter(r => r.some(c => String(c || "").trim() !== ""));
      if (!rows.length) return [];

      const headers = rows[0].map(String);
      const colLabel = findColIndex(headers, ["Название УЗ", "Название", "ВУЗ", "УЗ"]);
      const colAlias = findColIndex(headers, ["От пользователя", "Пользователь", "Alias", "Синоним"]);
      const colUnified = findColIndex(headers, ["Унифицированное", "Унифиц.", "Код", "ID"]);

      const li = (colLabel !== -1) ? colLabel : 0;
      const ai = (colAlias !== -1) ? colAlias : 1;
      const ui = (colUnified !== -1) ? colUnified : 2;

      const map = new Map(); // unified -> { label, unified, aliases:Set }

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const label = String(row[li] ?? "").trim();
        const alias = String(row[ai] ?? "").trim();
        const unified = String(row[ui] ?? "").trim();
        if (!unified) continue;

        if (!map.has(unified)) {
          map.set(unified, { label: label || unified, unified, aliases: new Set() });
        }
        const obj = map.get(unified);
        if (label) obj.label = label;
        if (label) obj.aliases.add(label);
        if (alias) obj.aliases.add(alias);
        obj.aliases.add(unified);
      }

      const built = [];
      for (const obj of map.values()) {
        const aliasStr = Array.from(obj.aliases).map(normalizeText).filter(Boolean).join(" | ");
        built.push({ label: obj.label, unified: obj.unified, searchBlob: aliasStr });
      }

      built.sort((a, b) => a.label.localeCompare(b.label, "ru"));
      sheetCache.set(sheetName, built);
      return built;
    } catch (error) {
      console.error("Ошибка загрузки списка вузов:", error);
      return [];
    }
  }

  async function ensureVuzLoaded() {
    const sheetName = pickSheetName();
    if (sheetName === loadedSheet && vuzEntries.length) return;
    loadedSheet = sheetName;
    vuzEntries = await loadVuzSheet(sheetName);
  }

  function hideVuzDropdown() {
    if (vuzDropdown) {
      vuzDropdown.style.display = "none";
      vuzDropdown.innerHTML = "";
    }
  }

  function showVuzDropdown(items) {
    if (!vuzDropdown || !items || items.length === 0) { hideVuzDropdown(); return; }

    vuzDropdown.innerHTML = "";
    items.forEach(item => {
      const div = document.createElement("div");
      div.textContent = item.label;
      div.className = "ft-dropdown-item";
      div.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        vuzInp.value = item.label;
        vuzUnifiedInp.value = item.unified;
        hideVuzDropdown();
      });
      vuzDropdown.appendChild(div);
    });
    vuzDropdown.style.display = "block";
  }

  function scoreItem(item, qNorm) {
    const lbl = normalizeText(item.label);
    if (lbl.startsWith(qNorm)) return 0;
    const idx = item.searchBlob.indexOf(qNorm);
    if (idx === 0) return 1;
    if (idx > 0) return 2;
    return 99;
  }

  function searchVuz(q) {
    const qNorm = normalizeText(q);
    if (qNorm.length < CONFIG.VUZ_MIN_CHARS || !vuzEntries.length) return [];

    const results = [];
    for (const item of vuzEntries) {
      if (item.searchBlob.includes(qNorm)) {
        results.push(item);
        if (results.length >= 250) break;
      }
    }

    results.sort((a, b) => {
      const sa = scoreItem(a, qNorm);
      const sb = scoreItem(b, qNorm);
      if (sa !== sb) return sa - sb;
      return a.label.localeCompare(b.label, "ru");
    });

    return results.slice(0, CONFIG.VUZ_SUGGEST_LIMIT);
  }

  function initVuzAutocomplete() {
    if (!vuzInp || !vuzDropdown) return;

    vuzInp.addEventListener("input", () => { vuzUnifiedInp.value = ""; });

    let vuzTimer = null;
    vuzInp.addEventListener("keyup", () => {
      clearTimeout(vuzTimer);
      vuzTimer = setTimeout(() => {
        const q = vuzInp.value || "";
        if (normalizeText(q).length < CONFIG.VUZ_MIN_CHARS) { hideVuzDropdown(); return; }
        showVuzDropdown(searchVuz(q));
      }, 80);
    });

    vuzInp.addEventListener("focus", async () => {
      try { await ensureVuzLoaded(); } catch(e) {}
      const q = vuzInp.value || "";
      if (normalizeText(q).length >= CONFIG.VUZ_MIN_CHARS) showVuzDropdown(searchVuz(q));
    });

    document.addEventListener("click", (e) => {
      if (vuzDropdown && !vuzDropdown.contains(e.target) && e.target !== vuzInp) hideVuzDropdown();
    });

    vuzDropdown.addEventListener("click", (e) => { e.stopPropagation(); });
  }

  // ====== INIT ======
  function initializeForm() {
    landingTypeInp.value = detectLandingType();
    if (CONFIG.IS_GENERAL_LANDING) landingTypeInp.value = CONFIG.LANDING_TYPE_GENERAL;

    populateForumOptions();

    if (CONFIG.IS_GENERAL_LANDING) {
      if (careerdayWrap) careerdayWrap.style.display = "block";
    } else {
      if (careerdayWrap) careerdayWrap.style.display = "none";
      if (careerdaySel) {
        const option = document.createElement("option");
        option.value = CONFIG.FORUM_FIXED;
        option.textContent = FORUM_NAMES_WITH_DATES[CONFIG.FORUM_FIXED] || CONFIG.FORUM_FIXED;
        careerdaySel.appendChild(option);
        careerdaySel.value = CONFIG.FORUM_FIXED;
      }
    }

    const initialForum = CONFIG.IS_GENERAL_LANDING ? "" : CONFIG.FORUM_FIXED;
    applyForumUI(initialForum);

    initVuzAutocomplete();
    ensureVuzLoaded().catch(() => {});
  }

  // ====== SUBMIT ======
  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    setError(errEmail, '');
    setError(errPhone, '');
    setError(errConsent, '');
    setError(errCustomFaculty, '');
    formMsg.textContent = '';
    formMsg.style.display = 'none';

    const email = (emailInp.value || '').trim();
    const phone = normalizePhone(phoneInp.value || '');
    if (phoneInp) phoneInp.value = phone;

    let isValid = true;

    if (!isValidEmail(email)) { setError(errEmail, 'Проверьте корректность email.'); isValid = false; }
    if (!isValidPhone(phone)) { setError(errPhone, 'Телефон должен быть в формате +79998887766.'); isValid = false; }

    if (CONFIG.IS_GENERAL_LANDING && (!careerdaySel.value || careerdaySel.value === "")) {
      formMsg.textContent = 'Пожалуйста, выберите форум для посещения.';
      formMsg.style.display = 'block';
      formMsg.style.color = '#ff6b6b';
      isValid = false;
    }

    if (streamSel.value === 'другое' && streamWrap.style.display !== 'none') {
      const customFaculty = (customFacultyInp.value || '').trim();
      if (!customFaculty) { setError(errCustomFaculty, 'Пожалуйста, укажите свой факультет.'); isValid = false; }
    }

    if (!consentChk.checked) { setError(errConsent, 'Нужно согласие, чтобы продолжить.'); isValid = false; }
    if (!isValid) return;

    submitBtn.disabled = true;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Отправляем...';

    try {
      const cd = CONFIG.IS_GENERAL_LANDING ? careerdaySel.value : CONFIG.FORUM_FIXED;
      const vuzTyped = (vuzInp.value || '').trim();
      const vuzUnified = (vuzUnifiedInp.value || '').trim();
      const vuzToSave = vuzUnified || vuzTyped || null;

      const streamValue = streamFinalInp.value || streamSel.value;

      const payload = {
        firstname: (firstnameInp.value || '').trim(),
        email,
        mobteleph: phone,
        vuz: vuzToSave,
        vuz_title: vuzTyped || null,
        vuz_unified: vuzUnified || null,
        careerday: cd,
        landing_type: CONFIG.IS_GENERAL_LANDING ? CONFIG.LANDING_TYPE_GENERAL : (landingTypeInp.value || detectLandingType() || null),
        year_of_grad: (cd === "ДОВ") ? null : (yearSel.value || null),
        age: (cd === "ДОВ") ? (ageSel.value || null) : null,
        stream: streamValue,
        consent: true,
        form_source: "telegram_webapp",
        page_url: location.href,
        ts: new Date().toISOString()
      };

      // UTM-метки
      const u = new URL(location.href);
      payload.utm_source = u.searchParams.get("utm_source") || "";
      payload.utm_medium = u.searchParams.get("utm_medium") || "";
      payload.utm_campaign = u.searchParams.get("utm_campaign") || "";
      payload.utm_content = u.searchParams.get("utm_content") || "";
      payload.utm_term = u.searchParams.get("utm_term") || "";
      payload.bot_tag = "";

      // Telegram доп. данные (полезно для аналитики/антифрода)
      if (tg) {
        payload.tg_init_data = tg.initData || "";
        payload.tg_user_id = tg.initDataUnsafe?.user?.id || null;
        payload.tg_username = tg.initDataUnsafe?.user?.username || null;
      }

      const response = await fetch(CONFIG.API_BASE, {
        method: 'POST',
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json().catch(() => ({}));
      if (!response.ok) throw new Error(data.message || 'Ошибка отправки формы');

      showSuccessMessage();
    } catch (error) {
      console.error('Ошибка отправки формы:', error);
      formMsg.textContent = 'Не получилось отправить форму. Попробуйте ещё раз чуть позже.';
      formMsg.style.display = 'block';
      formMsg.style.color = '#ff6b6b';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  });

  // init
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeForm);
  } else {
    initializeForm();
  }

})();
</script>

</body>
</html>
